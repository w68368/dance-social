generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

model User {
  id                   String          @id @default(cuid())
  email                String          @unique
  username             String          @unique
  passwordHash         String
  avatarUrl            String?
  failedLoginAttempts  Int             @default(0)
  lockUntil            DateTime?

  // –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –ª–∏ email
  emailVerifiedAt      DateTime?

  // ===== –°–≤—è–∑–∏ =====
  refreshTokens        RefreshToken[]
  passwordResets       PasswordReset[]

  // üÜï –°–≤—è–∑—å —Å –ø–æ—Å—Ç–∞–º–∏
  posts                Post[]

  // üÜï –õ–∞–π–∫–∏, –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
  likedPosts           PostLike[]

  // üÜï –ü–æ–¥–ø–∏—Å–∫–∏
  // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –ü–û–î–ü–ò–°–ê–ù–´ –Ω–∞ —ç—Ç–æ–≥–æ —é–∑–µ—Ä–∞
  followers            Follow[] @relation("FollowFollowing")
  // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –ü–û–î–ü–ò–°–ê–ù —ç—Ç–æ—Ç —é–∑–µ—Ä
  following            Follow[] @relation("FollowFollower")

  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  @@index([lockUntil])
}

model RefreshToken {
  id         String   @id @default(cuid())
  userId     String
  tokenHash  String   @unique
  userAgent  String?
  ip         String?
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  revokedAt  DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

//
// –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è e-mail
//
model EmailVerification {
  id          String    @id @default(cuid())
  email       String    @unique
  codeHash    String
  expiresAt   DateTime
  attempts    Int       @default(0)
  maxAttempts Int       @default(5)
  payload     Json
  createdAt   DateTime  @default(now())
}

//
// –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
//
model PasswordReset {
  id           String   @id @default(cuid())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String

  tokenHash    String   @unique
  expiresAt    DateTime
  usedAt       DateTime?
  createdAt    DateTime @default(now())

  requestedIp  String?
  requestedUA  String?

  @@index([expiresAt])
}

//
// üÜï –¢–∞–±–ª–∏—Ü–∞ –ø–æ—Å—Ç–æ–≤
//
model Post {
  id        String   @id @default(cuid())

  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId  String

  caption   String

  mediaType      String?  // "image" | "video"
  mediaUrl       String?
  mediaLocalPath String?

  // üÜï –õ–∞–π–∫–∏
  likes     PostLike[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([authorId, createdAt])
}

//
// üÜï –¢–∞–±–ª–∏—Ü–∞ –ª–∞–π–∫–æ–≤ –ø–æ—Å—Ç–æ–≤
//
model PostLike {
  id        String   @id @default(cuid())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String

  createdAt DateTime @default(now())

  // –æ–¥–∏–Ω –ª–∞–π–∫ –æ—Ç –æ–¥–Ω–æ–≥–æ —é–∑–µ—Ä–∞ –Ω–∞ –æ–¥–∏–Ω –ø–æ—Å—Ç
  @@unique([userId, postId])
  @@index([postId])
}

//
// üÜï –¢–∞–±–ª–∏—Ü–∞ –ø–æ–¥–ø–∏—Å–æ–∫ (follow)
// followerId  ‚Äî –∫—Ç–æ –ø–æ–¥–ø–∏—Å–∞–ª—Å—è
// followingId ‚Äî –Ω–∞ –∫–æ–≥–æ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å
//
model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  // —é–∑–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–¥–ø–∏—Å–∞–ª—Å—è
  follower  User @relation("FollowFollower", fields: [followerId], references: [id])
  // —é–∑–µ—Ä, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å
  following User @relation("FollowFollowing", fields: [followingId], references: [id])

  // –Ω–µ–ª—å–∑—è –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –¥–≤–∞ —Ä–∞–∑–∞ –Ω–∞ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ
  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}
